<%# MODIFIED FILE: Injects contacts into the standard assigned_to dropdown and maps selection %>
<% project_id = @project.try(:id)
   contacts = if project_id
     Contact.visible
            .joins("INNER JOIN contacts_projects cp ON cp.contact_id = contacts.id")
            .where("cp.project_id = ?", project_id)
            .order(:last_name, :first_name)
            .pluck(:id, :first_name, :last_name, :company)
   else
     Contact.visible.order(:last_name, :first_name).pluck(:id, :first_name, :last_name, :company)
   end %>
<%= hidden_field_tag :assigned_is_contact, '0' %>
<%= hidden_field_tag :assigned_contact_id, '' %>
<script>
  (function() {
    var select = document.getElementById('issue_assigned_to_id');
    if (!select) return;
    var og = document.createElement('optgroup');
    og.label = 'Contacts';
    var contacts = <%= raw contacts.map { |id, fn, ln, co| {id: id, name: [fn, ln, co].compact.join(' ').strip} }.to_json %>;
    contacts.forEach(function(c){
      var opt = document.createElement('option');
      opt.value = 'c_' + c.id;
      opt.textContent = c.name;
      og.appendChild(opt);
    });
    select.appendChild(og);
    select.addEventListener('change', function(e){
      var val = select.value || '';
      var isContact = val.startsWith('c_');
      var hiddenFlag = document.querySelector('input[name="assigned_is_contact"]');
      var hiddenId = document.querySelector('input[name="assigned_contact_id"]');
      if (isContact) {
        hiddenFlag.value = '1';
        hiddenId.value = val.substring(2);
      } else {
        hiddenFlag.value = '0';
        hiddenId.value = '';
      }
    });

    var form = select.closest('form');
    if (form) {
      form.addEventListener('submit', function() {
        var val = select.value || '';
        if (val.startsWith('c_')) {
          var hiddenFlag = document.querySelector('input[name="assigned_is_contact"]');
          var hiddenId = document.querySelector('input[name="assigned_contact_id"]');
          hiddenFlag.value = '1';
          hiddenId.value = val.substring(2);
          var dummy = document.createElement('option');
          dummy.value = '';
          dummy.textContent = '';
          select.appendChild(dummy);
          select.value = '';
        }
      });
    }
  })();
</script>
